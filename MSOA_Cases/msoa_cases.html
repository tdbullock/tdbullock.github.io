<html>
  <head>
    <!-- deck.gl standalone bundle -->
    <script src="https://unpkg.com/deck.gl@latest/dist.min.js"></script>
    <script src="https://unpkg.com/@deck.gl/carto@^8.3.0/dist.min.js"></script>

    <style type="text/css">
      body {background: #111; margin: 0; padding: 0;}
      #container {width: 100vw; height: 100vh;}
    </style>
  </head>

  <body>
    <div id="container"></div>
  </body>

  <script type="text/javascript">

// Source data GeoJSON
const DATA_URL =
  '/DATA/msoa_casesJson.geojson'; // eslint-disable-line

function colorScale(x) {
  const i = Math.round(x * 0.1);
  if (x < 0) {
    return COLOR_SCALE[i] || COLOR_SCALE[0];
  }
  return COLOR_SCALE[i] || COLOR_SCALE[COLOR_SCALE.length - 1];
}

const COLOR_SCALE = [
    [65, 182, 196],
    [127, 205, 187],
    [199, 233, 180],
    [237, 248, 177],
    // nine
    [255, 255, 204],
    [255, 237, 160],
    [254, 217, 118],
    [254, 178, 76],
    [253, 141, 60],
    [252, 78, 42],
    [227, 26, 28],
    [189, 0, 38],
    [128, 0, 38]
  ];

  const INITIAL_VIEW_STATE = {
  longitude: -1.415727,
  latitude: 52.232395,
  zoom: 6.6,
  minZoom: 5,
  maxZoom: 15,
  pitch: 40.5,
  bearing: -27
};





const MAP_STYLE = 'https://basemaps.cartocdn.com/gl/positron-nolabels-gl-style/style.json';

const ambientLight = new deck.AmbientLight({
  color: [255, 255, 255],
  intensity: 1.0
});


const pointLight1 = new deck.PointLight({
  color: [255, 255, 255],
  intensity: 0.8,
  position: [-0.144528, 49.739968, 80000]
});

const material = {
  ambient: 0.64,
  diffuse: 0.6,
  shininess: 32,
  specularColor: [51, 51, 51]
};
 
const landCover = [[[-123.0, 49.196], [-123.0, 49.324], [-123.306, 49.324], [-123.306, 49.196]]];



function getTooltip({object}) {
  return (
    object && {
      html: `\
  <div><b> ${object.properties.areaName}</b></div>
  <div>District: ${object.properties.msoa11nm}</div>
  <div><b>${object.properties.newcases}</b> new cases</div>
  <div>7-day case rate per 100k: <b>${object.properties.caserate}</b></div>
  `
    }
  );
}



const lightingEffect = new deck.LightingEffect({ambientLight, pointLight1});
//lightingEffect.shadowColor = [0, 0, 0, 0.5];



const deckgl = new deck.DeckGL({
  container: 'container',
  initialViewState: INITIAL_VIEW_STATE,
//  effects: lightingEffect,
  controller: true,
//  mapStyle: deck.carto.BASEMAP.POSITRON,
  mapStyle: MAP_STYLE,
  getTooltip:getTooltip,
  layers: [
    // only needed when using shadows - a plane for shadows to drop on
     new deck.PolygonLayer({
      id: 'ground',
      data: landCover,
      stroked: false,
      getPolygon: f => f,
      getFillColor: [0, 0, 0, 0]
    }), 
    new deck.GeoJsonLayer({
      id: 'geojson',
      data: DATA_URL,
      opacity: 1,
 //     colorRange,
      stroked: false,
      filled: true,
      extruded: true,
 //     material,
      wireframe: false,
  //    elevationRange: [1, 5000],
      elevationScale: 20,
      getElevation: f => f.properties.caserate,
      getFillColor: f => colorScale(f.properties.newcases),
      getLineColor: [255, 255, 255],
      pickable: true,
      transitions: {
        getElevation: 500,
        getFillColor: 500,
    },   
    })
  ]
});
  </script>
</html>