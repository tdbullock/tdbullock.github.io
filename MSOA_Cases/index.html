<html>
  <head>
    <title>
      COVID-19 England Cases by MSOA
    </title>
    <!-- deck.gl standalone bundle -->
    <script src="https://unpkg.com/deck.gl@latest/dist.min.js"></script>
    <script src="https://unpkg.com/@deck.gl/carto@^8.3.0/dist.min.js"></script>

    <!-- Mapbox dependencies -->
    <script src="https://api.tiles.mapbox.com/mapbox-gl-js/v1.4.0/mapbox-gl.js"></script>
    <link href="https://api.tiles.mapbox.com/mapbox-gl-js/v1.4.0/mapbox-gl.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/6.2.0/d3.min.js" integrity="sha512-C2RveGuPIWqkaLAluvoxyiaN1XYNe5ss11urhZWZYBUA9Ydgj+hfGKPcxCzTwut1/fmjEZR7Ac35f2aycT8Ogw==" crossorigin="anonymous"></script>
    <style type="text/css">
      body {
      background: #111; 
      margin: 0; 
      padding: 0;
      }
      #container {width: 100vw; height: 100vh;}
      
.legend{

	position: absolute;
	right: 0;
	top: 0;
	background-color: rgba(0,0,0,.65);
	color: #fff;
	padding: 7px;
	width: 50px;
	font-family: Graphik,sans-serif;
	font-size: .625rem;

}

.info{

position: absolute;
left: 0;
bottom: 0;
background-color: rgba(0,0,0,.65);
color: #fff;
padding: 7px;
width: 200px;
font-family: Graphik,sans-serif;
font-size: .625rem;

}

.legend-break {
	line-height: 1.1;
	margin-bottom: 1px;
	display: flex;
	align-items: center;
}

.deck-tooltip {
  font-family: Helvetica, Arial, sans-serif;
  position: absolute;
  padding: 4px;
  margin: 8px;
  background: rgba(0, 0, 0, 0.8);
  color: #fff;
  max-width: 300px;
  font-size: 13px;
  z-index: 9;
  pointer-events: none;
}
    </style>
  </head>

  <body>
    <div id="container"></div>
    <div class="legend">
     
      <div class="legend-break">
        <span style="display: inline-block; height: 1.5em; width: 0.75em; color: rgb(255, 255, 255); margin-right: 5px; background-color: rgb(65, 182, 196);"></span>
        <span>0</span>
      </div>
      <div class="legend-break">
        <span style="display: inline-block; height: 1.5em; width: 0.75em; color: rgb(255, 255, 255); margin-right: 5px; background-color: rgb(199, 233, 180);"></span>
        <span>10</span>
      </div>
      <div class="legend-break">
        <span style="display: inline-block; height: 1.5em; width: 0.75em; color: rgb(255, 255, 255); margin-right: 5px; background-color: rgb(255, 237, 160);"></span>
        <span>50</span>
      </div>
      <div class="legend-break">
        <span style="display: inline-block; height: 1.5em; width: 0.75em; color: rgb(255, 255, 255); margin-right: 5px; background-color: rgb(254, 217, 118);"></span>
        <span>100</span>
      </div>
      <div class="legend-break">
        <span style="display: inline-block; height: 1.5em; width: 0.75em; color: rgb(255, 255, 255); margin-right: 5px; background-color: rgb(254, 178, 76);"></span>
        <span>200</span>
      </div>
      <div class="legend-break">
        <span style="display: inline-block; height: 1.5em; width: 0.75em; color: rgb(255, 255, 255); margin-right: 5px; background-color: rgb(253, 141, 60);"></span>
        <span>400</span>
      </div>
      <div class="legend-break">
        <span style="display: inline-block; height: 1.5em; width: 0.75em; color: rgb(255, 255, 255); margin-right: 5px; background-color: rgb(189, 0, 38);"></span>
        <span>600</span>
      </div>
      <div class="legend-break">
        <span style="display: inline-block; height: 1.5em; width: 0.75em; color: rgb(255, 255, 255); margin-right: 5px; background-color: rgb(128, 0, 38);"></span>
        <span>800</span>
      </div>
    </div>
    <div class="info">
      <div class="legend-break">Updated:&nbsp;<span id="update"></span></div>
      <div class="legend-break">7 days rolling rate ending:&nbsp;<span id="latest"></span></div>
        <div class="legend-break">Case data: coronavirus.data.gov.uk</div>
        <div class="legend-break">Map data: geoportal.statistics.gov.uk</div>
      
    </div>
  </body>

  <script type="text/javascript">


var xmlhttp = new XMLHttpRequest();
xmlhttp.onreadystatechange = function() {
  if (this.readyState == 4 && this.status == 200) {
    var myObj = JSON.parse(this.responseText);
    document.getElementById("update").innerHTML = myObj.updates[0].updated;
    document.getElementById("latest").innerHTML = myObj.updates[0].latestdate;
  }
};
xmlhttp.open("GET", "updates.json", true);
xmlhttp.send();

// Source data GeoJSON
const DATA_URL =
  'msoa_casesJson.geojson'; // eslint-disable-line

function colorScale(x) {
  const i = Math.floor(x * 0.01);
  if (x < 0) {
    return COLOR_SCALE[i] || COLOR_SCALE[0];
  }
  return COLOR_SCALE[i] || COLOR_SCALE[COLOR_SCALE.length - 1];
}

 const COLOR_SCALE = d3.scaleThreshold()
  .domain([0, 10, 50, 100, 200, 400, 600, 800])
  .range([
   [65, 182, 196], // blue turquoise //10
   [199, 233, 180], //light green
   [255, 237, 160], // lighter yellow
   [254, 217, 118], // yellow
   [254, 178, 76], //tan
    // zero
    [253, 141, 60], //orange
    [189, 0, 38], // 900 // red
//    [254, 178, 76],
 //   [253, 141, 60],
 //   [252, 78, 42],
 //   [227, 26, 28],
 //   [189, 0, 38],
      [128, 0, 38] // 1000 // dark red
  ]);


/*
const COLOR_SCALE = [
    [65, 182, 196], // blue turquoise //10
 //   [127, 205, 187], // bluegreen
    [199, 233, 180], //light green
 //   [237, 248, 177], // pale green
    // nine
    [255, 255, 204], // very light yellow
    [255, 237, 160], // lighter yellow
    [254, 217, 118], // yellow
    [254, 178, 76], //tan
    [253, 141, 60], //orange
//    [252, 78, 42], // orangy red
    [227, 26, 28], // lighter red
    [189, 0, 38], // 900 // red
    [128, 0, 38] // 1000 // dark red
  ];
*/

  const INITIAL_VIEW_STATE = {
  longitude: -1.415727,
  latitude: 52.332395,
  zoom: 6.4,
  minZoom: 5,
  maxZoom: 15,
  pitch: 40.5,
  bearing: -27
};





const MAP_STYLE = 'https://basemaps.cartocdn.com/gl/positron-nolabels-gl-style/style.json';

const ambientLight = new deck.AmbientLight({
  color: [255, 255, 255],
  intensity: 1.0
});


const pointLight1 = new deck.PointLight({
  color: [255, 255, 255],
  intensity: 0.8,
  position: [-0.144528, 49.739968, 80000]
});

const material = {
  ambient: 0.64,
  diffuse: 0.6,
  shininess: 32,
  specularColor: [51, 51, 51]
};
 
const landCover = [[[-123.0, 49.196], [-123.0, 49.324], [-123.306, 49.324], [-123.306, 49.196]]];



function getTooltip({object}) {
  return (
    object && {
      html: `\
  <div><b> ${object.properties.areaName}</b></div>
  <div>District: ${object.properties.MSOA11NM}</div>
  <div><b>${object.properties.newcases}</b> new cases latest 7 days</div>
  <div>7-day case rate per 100k: <b>${object.properties.caserate}</b></div>
  `
    }
  );
}



const lightingEffect = new deck.LightingEffect({ambientLight, pointLight1});
//lightingEffect.shadowColor = [0, 0, 0, 0.5];



const deckgl = new deck.DeckGL({
  container: 'container',
  controller: true,
  initialViewState: INITIAL_VIEW_STATE,
//  effects: lightingEffect,
  controller: true,
  
  mapStyle: deck.carto.BASEMAP.DARK_MATTER,
//  mapStyle: MAP_STYLE,
  getTooltip:getTooltip,
  layers: [
    // only needed when using shadows - a plane for shadows to drop on
  /*   new deck.PolygonLayer({
      id: 'ground',
      data: landCover,
      stroked: false,
      getPolygon: f => f,
      getFillColor: [0, 0, 0, 0]
    }), */
    new deck.GeoJsonLayer({
      id: 'geojson',
      data: DATA_URL,
      opacity: 1,
 //     colorRange,
      stroked: false,
      filled: true,
      extruded: true,
 //     material,
      wireframe: false,
  //    elevationRange: [1, 5000],
      elevationScale: 100,
      getElevation: f => f.properties.newcases,
      getFillColor: f => COLOR_SCALE(f.properties.caserate),
      getLineColor: [255, 255, 255],
      pickable: true,
      transitions: {
        getElevation: 500,
        getFillColor: 500,
    },   
    })
  ]
});
  </script>
</html>